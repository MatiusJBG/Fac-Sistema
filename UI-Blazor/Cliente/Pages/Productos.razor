@page "/productos"
@using Microsoft.AspNetCore.Components
@using Application.DTOs
@using Cliente.Services
@using UI.Blazor.Cliente.Models
@inject IProductoService ProductoService
@inject NavigationManager NavigationManager


<PageTitle>Productos - Ecuafact</PageTitle>

<div class="productos-container">
    <div class="productos-header">
        <h1 class="productos-title">Productos</h1>
        <button class="btn btn-primary" @onclick="AbrirModalNuevoProducto">
            <i class="bi bi-plus-lg me-2"></i>Nuevo Producto
        </button>
    </div>

    <div class="productos-content">
        @if (ListaProductos != null && ListaProductos.Any())
        {
            <div class="productos-table">
                <div class="table-header">
                    <div class="table-col id">ID</div>
                    <div class="table-col tipo">Tipo</div>
                    <div class="table-col nombre">Nombre</div>
                    <div class="table-col fecha-exp">Fecha Exp.</div>
                    <div class="table-col cantidad">Cantidad</div>
                    <div class="table-col precio">Precio Unit.</div>
                </div>
                @foreach (var producto in ListaProductos)
                {
                    <div class="table-row">
                        <div class="table-col id">@producto.Id_Pro</div>
                        <div class="table-col tipo">@producto.Tip_Pro</div>
                        <div class="table-col nombre">@producto.Nom_Pro</div>
                        <div class="table-col fecha-exp">@producto.Fec_Exp_Pro.ToString("dd/MM/yyyy")</div>
                        <div class="table-col cantidad">@producto.Can_Pro</div>
                        <div class="table-col precio">$@producto.Pre_Uni.ToString("F2")</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-productos">
                <p>No hay productos registrados</p>
            </div>
        }
    </div>

    <!-- Modal Nuevo Producto -->
    @if (MostrarModalNuevoProducto)
    {
        <div class="modal-overlay" @onclick="CerrarModalNuevoProducto">
            <div class="modal-content" @onclick:stopPropagation="true">
               <NuevoProducto @ref="NuevoProductoComponent" OnGuardar="@GuardarProducto" OnCerrar="@CerrarModalNuevoProducto" />
            </div>
        </div>
    }
</div>

@code {
    private List<Producto> ListaProductos = new();
    private bool MostrarModalNuevoProducto = false;
    private NuevoProducto? NuevoProductoComponent;
    private Producto NuevoProductoModel = new();
    private bool cargando = false;
    private bool enviando = false;

    // Elimina estas l√≠neas:
    // private EventCallback<Producto> OnGuardar => EventCallback.Factory.Create<Producto>(this, GuardarProducto);
    // private EventCallback OnCerrar => EventCallback.Factory.Create(this, CerrarModalNuevoProducto);

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }

    private async Task CargarProductos()
    {
        try
        {
            cargando = true;
            var productosDto = await ProductoService.GetAllAsync();
            
            // Convertir ProductoDto a Producto local
            ListaProductos = productosDto.Select(p => new Producto
            {
                Id_Pro = p.Id_Pro,
                Tip_Pro = p.Tip_Pro,
                Nom_Pro = p.Nom_Pro,
                Fec_Exp_Pro = p.Fec_Exp_Pro,
                Can_Pro = p.Can_Pro,
                Pre_Uni = p.Pre_Uni
            }).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar productos: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void AbrirModalNuevoProducto()
    {
        NuevoProductoComponent?.ResetForm();
        MostrarModalNuevoProducto = true;
        StateHasChanged();
    }

    private void CerrarModalNuevoProducto()
    {
        MostrarModalNuevoProducto = false;
        StateHasChanged();
    }

    // Cambiar a void y hacer async internamente
    private void GuardarProducto(Producto nuevoProducto)
    {
        _ = GuardarProductoAsync(nuevoProducto);
    }

    private async Task GuardarProductoAsync(Producto nuevoProducto)
    {
        try
        {
            enviando = true;
            
            // Convertir de Producto a CreateProductoDto
            var createDto = new CreateProductoDto
            {
                Tip_Pro = nuevoProducto.Tip_Pro,
                Nom_Pro = nuevoProducto.Nom_Pro,
                Fec_Exp_Pro = nuevoProducto.Fec_Exp_Pro,
                Can_Pro = nuevoProducto.Can_Pro,
                Pre_Uni = nuevoProducto.Pre_Uni
            };
            
            await ProductoService.CreateAsync(createDto);
            await CargarProductos();
            CerrarModalNuevoProducto();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar producto: {ex.Message}");
        }
        finally
        {
            enviando = false;
        }
    }


}
