@page "/factura"
@using Microsoft.AspNetCore.Components.Forms
@using Application.DTOs
@using Cliente.Services
@inject IFacturaService FacturaService
@inject IClienteService ClienteService
@inject IProductoService ProductoService
@inject NavigationManager NavigationManager

@* Estilos locales para mejorar apariencia sin tocar archivos globales *@
<style>
    .factura-container { max-width: 1200px; margin: 0 auto; }
    .card-compact { border-radius: .6rem; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .totals-card { position: sticky; top: 80px; }
    .section-title { font-size: 1.05rem; font-weight: 600; }
    .small-muted { font-size: .85rem; color: #6c757d; }
    .action-btns .btn { min-width: 110px; }
    .input-sm { height: calc(1.5em + .5rem + 2px); }
</style>

<!-- Mensaje de estado -->
@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-@tipoMensaje alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; width: 400px;">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
    </div>
}

<div class="container-fluid mt-4 factura-container">
    <EditForm Model="@facturaModel" OnValidSubmit="@EnviarFactura">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Header / Breadcrumb -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="mb-1">Nueva Factura</h2>
                <div class="small-muted">Cree y administre facturas r√°pidamente</div>
            </div>
            <div>
                <small class="text-muted">Fecha: @facturaModel.FechaEmision.ToString("dd/MM/yyyy")</small>
            </div>
        </div>

        <div class="row g-4">
            <!-- Left: formulario principal -->
            <div class="col-lg-8">
                <!-- Encabezado -->
                <div class="card card-compact mb-3">
                    <div class="card-body">
                        <div class="row gy-3">
                            <div class="col-md-4">
                                <label class="form-label">Fecha de Emisi√≥n</label>
                                <InputDate @bind-Value="facturaModel.FechaEmision" class="form-control input-sm" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Establecimiento</label>
                                <select class="form-select" @bind="facturaModel.Establecimiento">
                                    <option value="">Seleccione...</option>
                                    <option value="001">001 - CAMINO</option>
                                    <option value="002">002 - CENTRO</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Punto de Venta</label>
                                <select class="form-select" @bind="facturaModel.PuntoVenta">
                                    <option value="">Seleccione...</option>
                                    @if (facturaModel.Establecimiento == "001")
                                    {
                                        <option value="001">001</option>
                                        <option value="002">002</option>
                                    }
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Cliente</label>
                                <div class="input-group">
                                    <InputText @bind-Value="terminoBusquedaCliente" 
                                               class="form-control" 
                                               placeholder="Buscar por nombre o c√©dula"
                                               @onkeyup="ActualizarBusquedaCliente" />
                                    <button type="button" class="btn btn-outline-secondary"
                                            @onclick="LimpiarClienteSeleccionado"
                                            style="display: @(clienteSeleccionadoTemp != null ? "block" : "none")">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                
                                @if (mostrarResultadosClientes && clientesFiltradosTemp.Any())
                                {
                                    <div class="list-group mt-2" style="max-height: 200px; overflow-y: auto;">
                                        @foreach (var cli in clientesFiltradosTemp)
                                        {
                                            <button type="button" class="list-group-item list-group-item-action" 
                                                    @onclick="() => SeleccionarClienteTemp(cli)">
                                                <strong>@cli.Nom_Cli @cli.Ape_Cli</strong><br/>
                                                <small>@cli.Ced_Cli - @cli.Tel_Cli</small>
                                            </button>
                                        }
                                    </div>
                                }

                                @if (clienteSeleccionadoTemp != null)
                                {
                                    <div class="alert alert-info mt-2 py-2">
                                        <strong>@clienteSeleccionadoTemp.Nom_Cli @clienteSeleccionadoTemp.Ape_Cli</strong><br/>
                                        <small>C√©dula: @clienteSeleccionadoTemp.Ced_Cli</small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos -->
                <div class="card card-compact mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="section-title">Productos</div>
                            <div>
                                <button type="button" class="btn btn-outline-primary" @onclick="AbrirSelectorProductos">
                                    <i class="bi bi-plus-lg me-1"></i> Agregar Producto
                                </button>
                            </div>
                        </div>

                        @if (!facturaModel.Productos.Any())
                        {
                            <div class="alert alert-secondary py-3">No hay productos agregados. Use "Agregar Producto" para comenzar.</div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Descripci√≥n</th>
                                            <th class="text-end">Cantidad</th>
                                            <th class="text-end">Precio</th>
                                            <th class="text-end">Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var (producto, index) in facturaModel.Productos.Select((x, i) => (x, i)))
                                        {
                                            <tr>
                                                <td>@producto.Codigo</td>
                                                <td>@producto.Descripcion</td>
                                                <td class="text-end">
                                                    <InputNumber @bind-Value="producto.Cantidad" 
                                                                 class="form-control form-control-sm" 
                                                                 style="max-width: 80px;" 
                                                                 @onchange="() => RecalcularSubtotales()" />
                                                </td>
                                                <td class="text-end">@producto.Precio.ToString("C2")</td>
                                                <td class="text-end">@((producto.Cantidad * producto.Precio).ToString("C2"))</td>
                                                <td class="text-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar" @onclick="() => EliminarProducto(index)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>

                <!-- Forma de Pago & Plazo -->
                <div class="row">
                    <div class="col-md-7">
                        <div class="card card-compact mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="section-title">Forma de Pago</div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AgregarFormaDePago">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="row gy-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Tipo de Pago</label>
                                        <select class="form-select" @bind="facturaModel.TipoPago">
                                            <option value="">Seleccione...</option>
                                            <option value="SIN_UTILIZACION">SIN UTILIZACI√ìN</option>
                                            <option value="EFECTIVO">EFECTIVO</option>
                                            <option value="TARJETA">TARJETA</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Valor</label>
                                        <div class="input-group">
                                            <InputNumber @bind-Value="facturaModel.ValorPago" class="form-control" />
                                            <span class="input-group-text">$</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card card-compact mb-3">
                            <div class="card-body">
                                <div class="section-title">Plazo del Pago</div>
                                <div class="row gy-2 mt-2">
                                    <div class="col-6">
                                        <InputNumber @bind-Value="facturaModel.PlazoPago" class="form-control" />
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select" @bind="facturaModel.UnidadTiempo">
                                            <option value="">Unidad</option>
                                            <option value="dias">D√≠as</option>
                                            <option value="semanas">Semanas</option>
                                            <option value="meses">Meses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Adicional -->
                <div class="card card-compact mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="section-title">Informaci√≥n Adicional</div>
                            <div class="small-muted">Campos libres para notas o instrucciones.</div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" @onclick="AgregarInfoAdicional">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Acci√≥n principal -->
                <div class="d-flex justify-content-end gap-2 action-btns mb-5">
                    <button type="button" class="btn btn-danger" @onclick="BorrarFactura">
                        <i class="bi bi-trash me-1"></i> Borrar
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="GuardarFactura" disabled="@(enviando || !facturaModel.Productos.Any() || clienteSeleccionadoTemp == null)">
                        @if (enviando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-save me-1"></i> Guardar
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@(enviando || !facturaModel.Productos.Any() || clienteSeleccionadoTemp == null)">
                        @if (enviando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-send me-1"></i> Enviar
                    </button>
                </div>
            </div>

            <!-- Right: Totales (sticky) -->
            <div class="col-lg-4">
                <div class="card card-compact totals-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-0">Totales</h5>
                                <div class="small-muted">Resumen</div>
                            </div>
                            <span class="badge bg-info text-dark">@facturaModel.Productos.Count items</span>
                        </div>

                        <dl class="row mb-0">
                            <dt class="col-8 small-muted">Subtotal</dt>
                            <dd class="col-4 text-end">@CalcularSubtotal().ToString("C2")</dd>

                            <dt class="col-8 small-muted">IVA (15%)</dt>
                            <dd class="col-4 text-end">@CalcularIVA().ToString("C2")</dd>
                        </dl>

                        <hr />
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-bold">Total</div>
                            <div class="fs-5 fw-semibold text-primary">@CalcularTotal().ToString("C2")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

<!-- Modal Selector de Productos -->
@if (mostrarSelectorProductos)
{
    <div class="modal d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccionar Producto</h5>
                    <button type="button" class="btn-close" @onclick="CerrarSelectorProductos"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Buscar producto..." 
                               @bind="terminoBusquedaProducto" />
                    </div>

                    @if (!productosDisponibles.Any())
                    {
                        <div class="alert alert-info">No hay productos disponibles</div>
                    }
                    else
                    {
                        <div class="row g-2" style="max-height: 400px; overflow-y: auto;">
                            @foreach (var producto in productosDisponibles.Where(p => 
                                string.IsNullOrEmpty(terminoBusquedaProducto) || 
                                p.Nom_Pro.Contains(terminoBusquedaProducto, StringComparison.OrdinalIgnoreCase)))
                            {
                                var yaAgregado = facturaModel.Productos.Any(d => d.Codigo == producto.Id_Pro.ToString());
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary w-100 text-start" 
                                            @onclick="() => AgregarProductoDelModal(producto)"
                                            disabled="@yaAgregado">
                                        <div>
                                            <strong>@producto.Nom_Pro</strong>
                                            @if (yaAgregado)
                                            {
                                                <span class="badge bg-success ms-2">Agregado</span>
                                            }
                                        </div>
                                        <small>Stock: @producto.Can_Pro | Precio: @producto.Pre_Uni.ToString("C2")</small>
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Modelo de la factura
    private FacturaModel facturaModel = new();
    private List<ProductoDto> productosDisponibles = new();
    private List<ClienteDto> clientesDisponibles = new();
    
    private string terminoBusquedaCliente = string.Empty;
    private List<ClienteDto> clientesFiltradosTemp = new();
    private ClienteDto? clienteSeleccionadoTemp;
    private bool mostrarResultadosClientes = false;
    
    private bool mostrarSelectorProductos = false;
    private bool enviando = false;
    private string terminoBusquedaProducto = string.Empty;
    private string mensaje = string.Empty;
    private string tipoMensaje = "success";

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
        await CargarClientes();
    }

    private async Task CargarProductos()
    {
        try
        {
            Console.WriteLine("üì• Cargando productos...");
            productosDisponibles = await ProductoService.GetAllAsync();
            Console.WriteLine($"üìä Productos cargados: {productosDisponibles.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al cargar productos: {ex.Message}");
            MostrarMensaje($"Error al cargar productos: {ex.Message}", "danger");
        }
    }

    private async Task CargarClientes()
    {
        try
        {
            Console.WriteLine("üì• Cargando clientes...");
            clientesDisponibles = await ClienteService.GetAllAsync();
            Console.WriteLine($"üìä Clientes cargados: {clientesDisponibles.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al cargar clientes: {ex.Message}");
            MostrarMensaje($"Error al cargar clientes: {ex.Message}", "danger");
        }
    }

    private void ActualizarBusquedaCliente()
    {
        if (string.IsNullOrWhiteSpace(terminoBusquedaCliente))
        {
            mostrarResultadosClientes = false;
            clientesFiltradosTemp.Clear();
            return;
        }

        clientesFiltradosTemp = clientesDisponibles
            .Where(c => c.Nom_Cli.Contains(terminoBusquedaCliente, StringComparison.OrdinalIgnoreCase) ||
                       c.Ape_Cli.Contains(terminoBusquedaCliente, StringComparison.OrdinalIgnoreCase) ||
                       c.Ced_Cli.Contains(terminoBusquedaCliente))
            .ToList();

        mostrarResultadosClientes = clientesFiltradosTemp.Any();
    }

    private void SeleccionarClienteTemp(ClienteDto cliente)
    {
        clienteSeleccionadoTemp = cliente;
        facturaModel.Cliente = cliente.Nom_Cli;
        terminoBusquedaCliente = cliente.Nom_Cli;
        mostrarResultadosClientes = false;
        MostrarMensaje($"Cliente seleccionado: {cliente.Nom_Cli}", "success");
    }

    private void LimpiarClienteSeleccionado()
    {
        clienteSeleccionadoTemp = null;
        terminoBusquedaCliente = string.Empty;
        facturaModel.Cliente = string.Empty;
        mostrarResultadosClientes = false;
    }

    private void AbrirSelectorProductos()
    {
        mostrarSelectorProductos = true;
    }

    private void CerrarSelectorProductos()
    {
        mostrarSelectorProductos = false;
        terminoBusquedaProducto = string.Empty;
    }

    private void AgregarProductoDelModal(ProductoDto producto)
    {
        facturaModel.Productos.Add(new ProductoModel 
        { 
            Codigo = producto.Id_Pro.ToString(), 
            Descripcion = producto.Nom_Pro, 
            Cantidad = 1, 
            Precio = producto.Pre_Uni 
        });
        RecalcularSubtotales();
        CerrarSelectorProductos();
        MostrarMensaje($"Producto '{producto.Nom_Pro}' agregado", "success");
    }

    private void EliminarProducto(int index)
    {
        facturaModel.Productos.RemoveAt(index);
        RecalcularSubtotales();
    }

    private async Task GuardarFactura()
    {
        Console.WriteLine("üíæ Guardando factura en base de datos...");
        
        try
        {
            if (!facturaModel.Productos.Any())
            {
                Console.WriteLine("‚ùå No hay productos");
                MostrarMensaje("Debe agregar productos a la factura", "warning");
                return;
            }

            if (clienteSeleccionadoTemp == null)
            {
                Console.WriteLine("‚ùå No hay cliente seleccionado");
                MostrarMensaje("Debe seleccionar un cliente", "warning");
                return;
            }

            Console.WriteLine($"‚úÖ Cliente: {clienteSeleccionadoTemp.Nom_Cli}");
            Console.WriteLine($"‚úÖ Productos: {facturaModel.Productos.Count}");

            enviando = true;

            // Crear DTO de factura
            var createFacturaDto = new CreateFacturaDto
            {
                Ced_Cli_Per = clienteSeleccionadoTemp.Ced_Cli,
                Detalles = facturaModel.Productos.Select(p => new CreateDetalleFacturaDto
                {
                    Id_Pro_Per = int.Parse(p.Codigo),
                    Can_Com = p.Cantidad
                }).ToList()
            };

            Console.WriteLine($"üì§ Enviando factura con {createFacturaDto.Detalles.Count} detalles");

            var factura = await FacturaService.CreateAsync(createFacturaDto);
            
            MostrarMensaje($"‚úì Factura #{factura.Id_Fac} guardada exitosamente. Total: {CalcularTotal().ToString("C2")}", "success");
            
            // Esperar un poco antes de limpiar
            await Task.Delay(1500);
            BorrarFactura();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al guardar: {ex.Message}");
            MostrarMensaje($"Error al guardar factura: {ex.Message}", "danger");
        }
        finally
        {
            enviando = false;
        }
    }

    private async Task EnviarFactura()
    {
        try
        {
            if (!facturaModel.Productos.Any())
            {
                MostrarMensaje("Debe agregar productos a la factura", "warning");
                return;
            }

            if (clienteSeleccionadoTemp == null)
            {
                MostrarMensaje("Debe seleccionar un cliente", "warning");
                return;
            }

            enviando = true;

            // Crear DTO de factura
            var createFacturaDto = new CreateFacturaDto
            {
                Ced_Cli_Per = clienteSeleccionadoTemp.Ced_Cli,
                Detalles = facturaModel.Productos.Select(p => new CreateDetalleFacturaDto
                {
                    Id_Pro_Per = int.Parse(p.Codigo),
                    Can_Com = p.Cantidad
                }).ToList()
            };

            var factura = await FacturaService.CreateAsync(createFacturaDto);
            
            MostrarMensaje($"‚úì Factura #{factura.Id_Fac} creada exitosamente. Total: {CalcularTotal().ToString("C2")}", "success");
            
            await Task.Delay(1500);
            BorrarFactura();
        }
        catch (Exception ex)
        {
            MostrarMensaje($"Error al enviar factura: {ex.Message}", "danger");
        }
        finally
        {
            enviando = false;
        }
    }

    private void BorrarFactura()
    {
        Console.WriteLine("Borrando factura...");
        facturaModel = new FacturaModel();
        clienteSeleccionadoTemp = null;
        terminoBusquedaCliente = string.Empty;
        mostrarResultadosClientes = false;
        MostrarMensaje("Factura borrada", "info");
    }

    private void AgregarFormaDePago()
    {
        Console.WriteLine("Agregando forma de pago...");
    }

    private void AgregarInfoAdicional()
    {
        Console.WriteLine("Agregando informaci√≥n adicional...");
    }

    private void RecalcularSubtotales()
    {
        var subtotal = facturaModel.Productos.Sum(p => p.Cantidad * p.Precio);
        
        facturaModel.SubtotalBase0 = 0m;
        facturaModel.SubtotalBaseIva = subtotal;
        facturaModel.SubtotalNoSujeto = 0m;
        facturaModel.SubtotalExento = 0m;
        
        StateHasChanged();
    }

    private decimal CalcularSubtotal()
    {
        return facturaModel.Productos.Sum(p => p.Cantidad * p.Precio);
    }

    private decimal CalcularIVA()
    {
        return CalcularSubtotal() * 0.15m;
    }

    private decimal CalcularTotal()
    {
        var subtotal = CalcularSubtotal();
        var iva = CalcularIVA();
        return subtotal + iva;
    }

    private void MostrarMensaje(string texto, string tipo = "success")
    {
        mensaje = texto;
        tipoMensaje = tipo;
    }

    // Clase modelo para la factura
    private class FacturaModel
    {
        public DateTime FechaEmision { get; set; } = DateTime.Now;
        public string Establecimiento { get; set; } = "";
        public string PuntoVenta { get; set; } = "";
        public string Cliente { get; set; } = "";
        public List<ProductoModel> Productos { get; set; } = new();
        public string TipoPago { get; set; } = "";
        public decimal ValorPago { get; set; }
        public int PlazoPago { get; set; }
        public string UnidadTiempo { get; set; } = "";
        public decimal SubtotalBase0 { get; set; }
        public decimal SubtotalBaseIva { get; set; }
        public decimal SubtotalNoSujeto { get; set; }
        public decimal SubtotalExento { get; set; }
    }

    // Clase modelo para productos
    private class ProductoModel
    {
        public string Codigo { get; set; } = "";
        public string Descripcion { get; set; } = "";
        public int Cantidad { get; set; }
        public decimal Precio { get; set; }
    }
}